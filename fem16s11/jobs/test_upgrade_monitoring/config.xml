<flow-definition plugin="workflow-job@2.25">
  <actions>
    <org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobAction plugin="pipeline-model-definition@1.3.2"/>
    <org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction plugin="pipeline-model-definition@1.3.2">
      <jobProperties/>
      <triggers/>
      <parameters/>
      <options/>
    </org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction>
  </actions>
  <description>ENM Cloud Native Upgrade Build pipeline MT_cENM_Upgrade_Functional - autogenerated using JobDSL - all manual changes will be overwritten!</description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <hudson.plugins.buildblocker.BuildBlockerProperty plugin="build-blocker-plugin@1.7.3">
      <useBuildBlocker>false</useBuildBlocker>
      <blockLevel>GLOBAL</blockLevel>
      <scanQueueFor>DISABLED</scanQueueFor>
      <blockingJobs/>
    </hudson.plugins.buildblocker.BuildBlockerProperty>
    <com.ericsson.duraci.messaging.ImplicitMessagingContributorProperty plugin="eiffel-core@69.0.3">
      <scriptEnabled>false</scriptEnabled>
    </com.ericsson.duraci.messaging.ImplicitMessagingContributorProperty>
    <jenkins.model.BuildDiscarderProperty>
      <strategy class="hudson.tasks.LogRotator">
        <daysToKeep>-1</daysToKeep>
        <numToKeep>30</numToKeep>
        <artifactDaysToKeep>-1</artifactDaysToKeep>
        <artifactNumToKeep>-1</artifactNumToKeep>
      </strategy>
    </jenkins.model.BuildDiscarderProperty>
    <com.sonyericsson.jenkins.plugins.bfa.model.ScannerJobProperty plugin="build-failure-analyzer@1.19.2">
      <doNotScan>false</doNotScan>
    </com.sonyericsson.jenkins.plugins.bfa.model.ScannerJobProperty>
    <org.jenkinsci.plugins.workflow.job.properties.DisableConcurrentBuildsJobProperty/>
    <com.ericsson.duraci.messaging.ImplicitEiffelMessagingJobProperty plugin="eiffel-core@69.0.3">
      <messagingEnabled>false</messagingEnabled>
      <jobFinishedDisabled>false</jobFinishedDisabled>
    </com.ericsson.duraci.messaging.ImplicitEiffelMessagingJobProperty>
    <com.sonyericsson.rebuild.RebuildSettings plugin="rebuild@1.29">
      <autoRebuild>false</autoRebuild>
      <rebuildDisabled>false</rebuildDisabled>
    </com.sonyericsson.rebuild.RebuildSettings>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>
        <hudson.model.StringParameterDefinition>
          <name>environment_name</name>
          <description>Deployment name of cENM Cloud Deployment to be Upgraded</description>
          <defaultValue/>
          <trim>true</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>MONITORING_INTEGRATION_CHART_VERSION</name>
          <description/>
          <defaultValue/>
          <trim>true</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>INTEGRATION_VALUE_VERSION</name>
          <description/>
          <defaultValue/>
          <trim>true</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.ChoiceParameterDefinition>
          <name>stage_area</name>
          <description>This parameter acts as the flow controller to download charts from internal area or release area</description>
          <choices class="java.util.Arrays$ArrayList">
            <a class="string-array">
              <string>ci_internal</string>
              <string>release</string>
            </a>
          </choices>
        </hudson.model.ChoiceParameterDefinition>
        <org.jvnet.jenkins.plugins.nodelabelparameter.LabelParameterDefinition plugin="nodelabelparameter@1.7.2">
          <name>SLAVE</name>
          <description/>
          <defaultValue>Jenkins_Upgrade_CSAR_Slave_4Node_MISTY_5</defaultValue>
          <allNodesMatchingLabel>false</allNodesMatchingLabel>
          <triggerIfResult>allCases</triggerIfResult>
          <nodeEligibility class="org.jvnet.jenkins.plugins.nodelabelparameter.node.AllNodeEligibility"/>
        </org.jvnet.jenkins.plugins.nodelabelparameter.LabelParameterDefinition>
      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
  </properties>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.57.2">
    <script>#!/usr/bin/env groovy

/* In order to make this pipeline work, the following configuration on Jenkins is required:
 * - slave with a specific label (see pipeline.agent.label below)
 * - credentials plugin should be installed and have the secrets with the following names:
 * - Monitoring Upgrade jenkins file upgrades the existing Monitoring II with latest charts:
 */


/*
 * This function will captures the report of the deployment and sends the report through mail
 */

def emailReport(content){

    def subject = "${env.JOB_NAME} - Build #${env.BUILD_NUMBER} - ${currentBuild.currentResult}!"

    try {
        emailext(body: content, mimeType: 'text/html', from: 'jenkins_monitoring@ericsson.com',
            subject: subject,
            to: "${EMAIL_LIST}" )
    } catch( err ){
        echo "$err"
    }
}

/*
 * This function will generates report of the deployment.
 */

def reportHeading(status){

    def deployResult
    def color
    def investigation

    if(status == 'Success'){
        deployResult = "Success"
        color = "#9ACD32"
        investigation = "NA"
    } else if(status == 'Failed'){
        deployResult = "Failed"
        color = "#DC143C"
        investigation = "In progress, will be included in a follow up email"
    } else if(status == 'Aborted'){
        deployResult = "Aborted"
        color = "#95A5A6"
        investigation = "(If applicable), will be included in a follow up email"
    }

    def report = "Hi All,\n\n &lt;h2&gt;${NAMESPACE} Deployment Result: &lt;span style=\"background-color:${color};\"&gt;${status}&lt;/span&gt;&lt;/h2&gt;"
    def MonitoringchartVersion = sh (script : "${helm} list -n ${NAMESPACE} | grep  eric-enm-monitoring-integration-${NAMESPACE} | awk \'{print \$(NF-1)}\'", returnStdout: true)
    report += "&lt;li&gt;&lt;strong&gt;Monitoring Chart version :&lt;/strong&gt; ${MonitoringchartVersion}&lt;/li&gt;"
    report += "&lt;li&gt;&lt;strong&gt;Please find the Phase 1 Deploy Job Details:&lt;/strong&gt;  &lt;a href=${BUILD_URL}&gt;${BUILD_URL}&lt;/a&gt;&lt;/li&gt;"
    report += "&lt;li&gt;&lt;strong&gt;Investigation Results  :  ${investigation}&lt;/strong&gt;&lt;/li&gt;&lt;/ul&gt;"
    report = report.replace("\n","&lt;/br&gt;")
    return report
}

/*
 * This function will print the list of unstable pods after Upgrade
 */

def printPods(){
    def RestartPods = sh (script : "\${kubectl} -n \${NAMESPACE} get pods --sort-by=\'.status.containerStatuses[0].restartCount\' --no-headers|egrep 'prometheus|remotewriter|monitoring'| awk \'\$4&gt;0 {print \$0}\'", returnStdout: true)
    def failedState = sh (script : "${kubectl} -n ${NAMESPACE} get pods | egrep \'NAME|Running\' | egrep \'0/|NAME\'" , returnStdout: true)
    def initState = sh (script : "${kubectl} -n ${NAMESPACE} get pods | grep -v Running |grep -v Completed || true", returnStdout: true)
    def sidecarhttpd= sh (script : "${kubectl} -n ${NAMESPACE} get pods | egrep \'NAME|Running\' | egrep \'1/2|NAME\'" , returnStdout: true)
    def sidecarmonitoring= sh (script : "${kubectl} -n ${NAMESPACE} get pods | egrep \'NAME|Running\' | egrep \'2/3|NAME\'" , returnStdout: true)
    def report = "&lt;ul&gt;&lt;li&gt;&lt;strong&gt;Please find the Restart Pods in Deployment:&lt;/strong&gt; \n&lt;pre&gt;${RestartPods}&lt;/pre&gt; \n\n\n #kubectl -n ${NAMESPACE} get pods | egrep \'NAME|Running\' | egrep \'0/|NAME\' \n&lt;pre&gt;${failedState}&lt;/pre&gt; \n\n\n #kubectl -n ${NAMESPACE} get pods | grep -v Running \n&lt;pre&gt;${initState}&lt;/pre&gt; \n\n\n #kubectl -n ${NAMESPACE} get pods | egrep \'NAME|Running\' | egrep \'1/2|NAME\' \n&lt;pre&gt;${sidecarhttpd}&lt;/pre&gt; \n\n\n #kubectl -n ${NAMESPACE} get pods | egrep \'NAME|Running\' | egrep \'2/3|NAME\' \n&lt;pre&gt;${sidecarmonitoring}&lt;/pre&gt;"
    echo "${report}"
    report = report.replace("\n","&lt;/br&gt;")
    report += "&lt;style&gt; pre {display: block;font-family: Lucida Console, Monaco, monospace; white-space: pre;} &lt;/style&gt;";

    return report
}

/*
 * This function is required to check if the integration parameters  exists in integration values.yaml file or not.
 */

def integration_values_file_keys_exists(element, keys,value){
     def str = keys.tokenize(".");
    _element = element
    _flag = false
     for (i = 0; i &lt; str.size(); i++) {
        try{
           if ( _element!=null&amp;&amp;_element.containsKey(str[i])){
              _element = _element[str[i]]
              if(i==str.size()-1){
                _flag=true
              }
           }
           } catch( err ) {
              return false
            }
        }
         return  _flag
}

/*
 * This function will update value of the key in integration values.yaml file.
 */

def update_IntegrationValues_with_values(keys,value){
     def str = keys.tokenize(".");
     def bindings = [:]

     def map = bindings
     for (i = 0; i &lt; str.size(); i++) {
       def part = str[i];
       if (!map.containsKey(part)) {
           map[part] = values.get(part)
       }
       if (i == str.size() - 1) {
           map[part] = value
       } else {
          map = map[part]
       }
     }
    values.putAll(bindings)
}


/*
 * This function is required to Update the integration values.yaml file with site-config properties
 */

def updateIntegrationValues() {
    try {
        def integration_value_map = [
                       'global.persistentVolumeClaim.storageClass':'STORAGE_CLASS',
                       'global.ingress.enmHost':'ENM_LAUNCHER_HOSTNAME',
                       'global.rwx.storageClass':'RWX_STORAGE_CLASS',
                       'global.timezone':'TIME_ZONE',
                       'prometheus-operator.prometheusOperator.kubeletService.namespace':'NAMESPACE',
                       'prometheus-operator.kubelet.namespace':'NAMESPACE',
                       'prometheus-operator.prometheus.prometheusSpec.serviceMonitorNamespaceSelector.matchLabels.name':'NAMESPACE',
                       'prometheus-operator.prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.storageClassName':'STORAGE_CLASS',
                       'prometheus-operator.prometheus-node-exporter.service.port':'NODE_EXPORTER_PORT',
                       'prometheus-operator.prometheus-node-exporter.service.targetPort':'NODE_EXPORTER_PORT',
                       'eric-enm-monitoring-master.monitoring.autoUpload.ddpsite':'DDPSITE',
                       'eric-enm-monitoring-master.monitoring.autoUpload.account':'ACCOUNT',
                       'eric-enm-monitoring-master.monitoring.autoUpload.password':'PASSWORD',
                       'prometheus-operator.grafana.ingress.hosts' : 'GRAFANA_HOSTS'
                       ]
        def list_all_environment = env.getEnvironment()
        filename = "${HOME_DIR}/eric-enm-monitoring-integration-values-${INTEGRATION_VALUE_VERSION}.yaml"
        values = readYaml file: filename
        for (parameter in integration_value_map){
         def value = parameter.value
         def key = parameter.key
         if (integration_values_file_keys_exists( values, key, value)){
               value= list_all_environment.get(value)
                      if ( key == 'prometheus-operator.grafana.ingress.hosts' )
                            {
                             value=[value]
                            }
               update_IntegrationValues_with_values(key,value)
         }
       }
        sh "rm -f ${filename}"
        writeYaml file: filename, data: values
    } catch( err ) {
        echo "$err"
        sh "exit 1"
    }
}

/*
 * This function is required to download the integration charts and integration values file from CI Internal area which can be used by * both Integration and MT teams.
 */

def download_charts_ci_internal(){
  try{
          sh "curl ${helm_repository_ci_internal}/eric-enm-monitoring-integration/eric-enm-monitoring-integration-${MONITORING_INTEGRATION_CHART_VERSION}.tgz -o eric-enm-monitoring-integration-${MONITORING_INTEGRATION_CHART_VERSION}.tgz"
          sh "curl ${helm_repository_ci_internal}/eric-enm-integration-values/eric-enm-monitoring-integration-values-${INTEGRATION_VALUE_VERSION}.yaml -o eric-enm-monitoring-integration-values-${INTEGRATION_VALUE_VERSION}.yaml"
     }catch( err )
        {
        echo "$err"
        sh "exit 1"
      }
}

/*
 * This function is required to download the integration charts and integration values file from drop area which can be used by
 * both Integration and MT teams.
 */

def download_charts_release_area(){
  try{
          sh "curl ${helm_repository_release}/eric-enm-monitoring-integration/eric-enm-monitoring-integration-${MONITORING_INTEGRATION_CHART_VERSION}.tgz -o eric-enm-monitoring-integration-${MONITORING_INTEGRATION_CHART_VERSION}.tgz"
          sh "curl ${helm_repository_release}/eric-enm-integration-values/eric-enm-monitoring-integration-values-${INTEGRATION_VALUE_VERSION}.yaml -o eric-enm-monitoring-integration-values-${INTEGRATION_VALUE_VERSION}.yaml"
     }catch( err ) {
        echo "$err"
        sh "exit 1"
      }
}

/*
 * This function is required to get the charts and integration values file from respective folder which will be used in the Upgrade
 * stage
 */


/*
 *This function is required to read the values from the Site-Config-File of specified deployment.
 */

def read_site_config_file(){
    def site_config_properties = readProperties  (file:"Site-Config-File/${environment_name}")
    env.KUBE_CRED = site_config_properties['KUBE_CRED']
    env.NAMESPACE = site_config_properties['NAMESPACE']
    env.RWX_STORAGE_CLASS =site_config_properties['RWX_STORAGE_CLASS']
    env.STORAGE_CLASS =site_config_properties['STORAGE_CLASS']
    env.TIME_ZONE=site_config_properties['TIME_ZONE']
    env.NODE_EXPORTER_PORT=site_config_properties['NODE_EXPORTER_PORT']
    env.ENM_LAUNCHER_HOSTNAME=site_config_properties['ENM_LAUNCHER_HOSTNAME']
    env.DDPSITE = site_config_properties['DDPSITE']
    env.ACCOUNT = site_config_properties['ACCOUNT']
    env.PASSWORD = site_config_properties['PASSWORD']
    env.GRAFANA_HOSTS = site_config_properties['GRAFANA_HOSTS']
    env.EMAIL_LIST=site_config_properties['EMAIL_LIST']
    env.kubeConfig = "${workspace}/.kube/${KUBE_CRED}"
    env.helm = "docker run --rm -v ${kubeConfig}:/root/.kube/config -v ${WORKSPACE}:${WORKSPACE} --workdir ${WORKSPACE} ${cenm_utilities_docker_image} helm3"
    env.kubectl = "docker run --rm  -v ${kubeConfig}:/root/.kube/config -v ${WORKSPACE}:${WORKSPACE} --workdir ${WORKSPACE} ${cenm_utilities_docker_image} kubectl"
}

pipeline{
    agent {
            node
            {
            label SLAVE
            }
        }
    environment {
        HOME_DIR = "${WORKSPACE}"
        https_proxy = "http://www-proxy.lmera.ericsson.se:8080/"
        cenm_utilities_docker_image = "armdocker.rnd.ericsson.se/proj-enm/cenm-build-utilities:latest"
        helm_repository_release = "https://arm.seli.gic.ericsson.se/artifactory/proj-enm-helm/"
        helm_repository_ci_internal = "https://arm.seli.gic.ericsson.se/artifactory/proj-enm-dev-internal-helm/"
    }
    stages{
        stage('Clean Up WorkSpace'){
                steps{
                        deleteDir()
                     }
        }
        stage('Checkout ENM Integration Pipeline Git Repository') {
            steps {
                git branch: 'master',
                        url: 'ssh://gerrit.ericsson.se:29418/OSS/com.ericsson.oss.containerisation/eric-enm-integration-pipeline-code'
            }
        }

        stage( 'Site Config Properties' ) {
            steps {
                 script{
                         read_site_config_file()
                      }
              }
        }
        stage( 'Pre Configurations' ) {
            steps {
                   sh 'mkdir -p ${PWD}/.kube &amp;&amp; chmod 775 ${PWD}/.kube &amp;&amp; cp -v ${PWD}/Kube-Config-Files/${KUBE_CRED} ${PWD}/.kube/${KUBE_CRED} &amp;&amp; chmod 664 ${PWD}/.kube/${KUBE_CRED}'

            }
        }
        stage('Download Charts from CI Internal') {
            when {
                 allOf {
                     environment name: 'stage_area', value: 'ci_internal'
                 }
            }
            steps {
                script {
                   download_charts_ci_internal()
                }
            }
        }
        stage('Download Charts from Release area') {
            when {
                 allOf {
                     environment name: 'stage_area', value: 'release'
                 }
            }
            steps {
                script {
                   download_charts_release_area()
                }
            }
        }
        stage('Updating integration values'){
            steps{
                script{
                    updateIntegrationValues()
                }
            }
        }

        stage('Generate artifact file'){
             steps{
                  script{
                        sh 'echo "environment_name=${environment_name}" &gt;&gt; artifact.properties'
                        archiveArtifacts 'artifact.properties'
                        }
                  }
                }
    }
    post{
        failure {
            script{
                echo "Failure"
                def report = reportHeading("Failed")
                report += printPods()
                emailReport(report)
            }
        }
        aborted{
            script{
                echo "Aborted"
                def report = reportHeading("Aborted")
                report += printPods()
                emailReport(report)
            }
        }
        success{
            script{
                echo "Success"
                def report = reportHeading("Success")
                report +=printPods()
                emailReport(report)
            }
        }
        always {
            script{
                currentBuild.displayName = "Upgrade with on: ${environment_name}"
                sh("cat ${HOME_DIR}/eric-enm-monitoring-integration-values-${INTEGRATION_VALUE_VERSION}.yaml")
                archiveArtifacts "eric-enm-monitoring-integration-values-${INTEGRATION_VALUE_VERSION}.yaml"
            }
        }
    }
}</script>
    <sandbox>true</sandbox>
  </definition>
  <triggers/>
  <disabled>true</disabled>
</flow-definition>